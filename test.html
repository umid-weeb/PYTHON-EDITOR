<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isroilov's Online Editor</title>
    <link rel="icon" type="image/png" href="/assets/image_icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/anyword-hint.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
          <h1>
            <span class="status-indicator"><img class="fa-python" src="/assets/image.png" alt=""></span>
            Python Online Editor
        </h1> 
            <div class="header-buttons">
                <button class="btn-run" onclick="runCode()">â–¶ Run</button>
                <button class="btn-clear" onclick="clearOutput()">âœ– Clear</button>
                <button class="btn-save" onclick="saveCode()">ğŸ’¾ Save</button>
                <button class="btn-load" onclick="loadCode()">ğŸ“‚ Load</button>
                <button class="btn-download" onclick="downloadCode()">â¬‡ Download</button>
                <button class="btn-upload" onclick="document.getElementById('fileInput').click()">ğŸ“¤ Upload</button>
                <button class="btn-theme" onclick="toggleTheme()" id="themeBtn">ğŸŒ™ Dark</button>
                <input type="file" id="fileInput" accept=".py,.txt" onchange="uploadFile(event)">
            </div>
        </div>

        <div class="loading" id="loading">â³ Python muhiti yuklanmoqda...</div>

        <div class="editor-container">
                    <div class="editor-panel">
                <div class="panel-header">ğŸ“ Kod Muharriri</div>
                <textarea id="code-editor"># Python kodingizni bu yerga yozing
print("Salom, Python!")
for i in range(5):
    print("*" *i) 
</textarea>
            </div>

            <div class="output-panel">
                <div class="panel-header">ğŸ“Š Natija</div>
                <div class="output-content" id="output">Natija bu yerda ko'rsatiladi...</div>
            </div>
        </div>
    </div>

    <script>
        let pyodide;
        let editor;
        let autoSaveInterval;
        let defaultCode = ''; // Default kodni saqlab turish uchun

        window.addEventListener('DOMContentLoaded', function() {
            // Textarea'dan default kodni olish
            const textarea = document.getElementById('code-editor');
            defaultCode = textarea.value;

            editor = CodeMirror.fromTextArea(textarea, {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                indentUnit: 4,
                indentWithTabs: false,
                lineWrapping: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                extraKeys: {
                    "Ctrl-Space": "autocomplete",
                    "Tab": function(cm) {
                        // Agar hint ochiq bo'lsa, tanlangan hintni qo'llash
                        if (cm.state.completionActive) {
                            return CodeMirror.Pass;
                        }
                        // Aks holda oddiy tab
                        cm.replaceSelection("    ");
                    }
                },
                hintOptions: {
                    completeSingle: false,
                    alignWithWord: true,
                    closeOnUnfocus: true
                }
            });

            // Auto-close brackets va quotes
            setupAutoClose();

            // Autocomplete setup
            setupAutocomplete();

            // Sahifa ochilganda oxirgi kodni yuklash
            loadAutoSavedCode();

            // Dark mode yuklash
            loadTheme();

            // Har 10 sekundda avtomatik saqlash
            startAutoSave();

            initPyodide();
        });

        function setupAutoClose() {
            const pairs = {
                '(': ')',
                '[': ']',
                '{': '}',
                '"': '"',
                "'": "'"
            };

            editor.on('keydown', function(cm, event) {
                const char = event.key;
                
                // Agar ochuvchi belgi bosilsa
                if (pairs[char] && !event.ctrlKey && !event.metaKey && !event.altKey) {
                    event.preventDefault();
                    
                    const cursor = cm.getCursor();
                    const selection = cm.getSelection();
                    
                    if (selection) {
                        // Agar text tanlangan bo'lsa
                        cm.replaceSelection(char + selection + pairs[char]);
                        cm.setCursor({line: cursor.line, ch: cursor.ch + selection.length + 1});
                    } else {
                        // Oddiy holat
                        const nextChar = cm.getRange(cursor, {line: cursor.line, ch: cursor.ch + 1});
                        
                        // Agar keyingi belgi yopuvchi belgi bo'lsa, faqat o'tish
                        if (nextChar === pairs[char] && (char === '"' || char === "'")) {
                            cm.setCursor({line: cursor.line, ch: cursor.ch + 1});
                        } else {
                            // Juftini qo'shish
                            cm.replaceRange(char + pairs[char], cursor);
                            cm.setCursor({line: cursor.line, ch: cursor.ch + 1});
                        }
                    }
                }
                
                // Backspace bosilganda juftlikni o'chirish
                else if (event.key === 'Backspace') {
                    const cursor = cm.getCursor();
                    const charBefore = cm.getRange({line: cursor.line, ch: cursor.ch - 1}, cursor);
                    const charAfter = cm.getRange(cursor, {line: cursor.line, ch: cursor.ch + 1});
                    
                    if (pairs[charBefore] === charAfter) {
                        event.preventDefault();
                        cm.replaceRange('', {line: cursor.line, ch: cursor.ch - 1}, {line: cursor.line, ch: cursor.ch + 1});
                    }
                }
            });
        }

        function setupAutocomplete() {
            // Python keywords va built-in funksiyalar
            const pythonKeywords = [
                'False', 'None', 'True', 'and', 'as', 'assert', 'async', 'await', 
                'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 
                'finally', 'for', 'from', 'global', 'if', 'import', 'in', 'is', 
                'lambda', 'nonlocal', 'not', 'or', 'pass', 'raise', 'return', 
                'try', 'while', 'with', 'yield',
                'print', 'input', 'len', 'range', 'str', 'int', 'float', 'list', 
                'dict', 'set', 'tuple', 'bool', 'type', 'open', 'file', 'round',
                'abs', 'all', 'any', 'sum', 'min', 'max', 'sorted', 'reversed',
                'enumerate', 'zip', 'map', 'filter', 'help'
            ];

            // Math module funksiyalari
            const mathFunctions = [
                'math.sqrt', 'math.pow', 'math.floor', 'math.ceil', 'math.round',
                'math.sin', 'math.cos', 'math.tan', 'math.asin', 'math.acos', 'math.atan',
                'math.log', 'math.log10', 'math.exp', 'math.pi', 'math.e',
                'math.degrees', 'math.radians', 'math.factorial'
            ];

            // Foydalanuvchi kodidan funksiya va o'zgaruvchilarni topish
            function getUserDefinedNames(editor) {
                const code = editor.getValue();
                const names = new Set();
                
                // Funksiyalarni topish: def function_name(
                const funcRegex = /def\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;
                let match;
                while ((match = funcRegex.exec(code)) !== null) {
                    names.add(match[1]);
                }
                
                // Classlarni topish: class ClassName
                const classRegex = /class\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;
                while ((match = classRegex.exec(code)) !== null) {
                    names.add(match[1]);
                }
                
                // O'zgaruvchilarni topish: variable_name = value
                const varRegex = /([a-zA-Z_][a-zA-Z0-9_]*)\s*=/g;
                while ((match = varRegex.exec(code)) !== null) {
                    names.add(match[1]);
                }
                
                return Array.from(names);
            }

            // Custom autocomplete funksiyasi
            CodeMirror.registerHelper('hint', 'pythonComplete', function(editor) {
                const cursor = editor.getCursor();
                const token = editor.getTokenAt(cursor);
                const line = editor.getLine(cursor.line);
                const start = token.start;
                const end = cursor.ch;
                const currentWord = line.slice(start, end);

                let list = [];

                // Foydalanuvchi yaratgan nomlarni olish
                const userNames = getUserDefinedNames(editor);

                // Agar "math." yozilgan bo'lsa
                if (line.slice(Math.max(0, end - 5), end) === 'math.') {
                    list = mathFunctions.map(f => f.replace('math.', ''));
                } 
                // Agar oddiy so'z yozilayotgan bo'lsa
                else if (currentWord) {
                    // Foydalanuvchi nomlari
                    const userMatches = userNames.filter(word => 
                        word.toLowerCase().startsWith(currentWord.toLowerCase())
                    );
                    
                    // Python keywords
                    const keywordMatches = pythonKeywords.filter(word => 
                        word.toLowerCase().startsWith(currentWord.toLowerCase())
                    );
                    
                    // Math modulini ham qo'shish
                    const mathMatch = 'math'.startsWith(currentWord.toLowerCase()) ? ['math'] : [];
                    
                    // Birlashtirib, foydalanuvchi nomlarini birinchi qo'yish
                    list = [...userMatches, ...keywordMatches, ...mathMatch];
                } 
                // Hech narsa yo'q bo'lsa
                else {
                    list = [...userNames, ...pythonKeywords.slice(0, 15)];
                }

                // Dublikatlarni olib tashlash
                list = [...new Set(list)];

                return {
                    list: list,
                    from: CodeMirror.Pos(cursor.line, start),
                    to: CodeMirror.Pos(cursor.line, end)
                };
            });

            // Yozish paytida avtomatik tavsiya
            editor.on('inputRead', function(cm, change) {
                if (change.text[0].match(/[a-zA-Z_]/)) {
                    CodeMirror.commands.autocomplete(cm, null, {
                        hint: CodeMirror.hint.pythonComplete,
                        completeSingle: false
                    });
                }
            });
        }

        // Sahifa yopilayotganda oxirgi holatni saqlash
        window.addEventListener('beforeunload', function() {
            autoSaveCode();
        });

        function startAutoSave() {
            // Har 10 sekundda avtomatik saqlash
            autoSaveInterval = setInterval(() => {
                autoSaveCode();
            }, 10000);
        }

        function autoSaveCode() {
            const code = editor.getValue();

            // Faqat default koddan farq qilsa saqlash
            if (code.trim() !== defaultCode.trim()) {
                const timestamp = new Date().toLocaleString('uz-UZ');
                
                const autoSaveData = {
                    code: code,
                    timestamp: timestamp,
                    lastSaved: Date.now()
                };

                localStorage.setItem('pythonAutoSave', JSON.stringify(autoSaveData));
            }
        }

        function loadAutoSavedCode() {
            const autoSaveData = localStorage.getItem('pythonAutoSave');
            
            if (autoSaveData) {
                try {
                    const data = JSON.parse(autoSaveData);
                    
                    // Faqat kod bor bo'lsa yuklash
                    if (data.code && data.code.trim()) {
                        editor.setValue(data.code);
                        
                        const timeSaved = new Date(data.lastSaved).toLocaleString('uz-UZ');
                        showOutput(`âœ… Oxirgi sessiya qayta tiklandi\nğŸ“… Saqlangan vaqt: ${timeSaved}`, 'success');
                        
                        setTimeout(() => {
                            clearOutput();
                        }, 3000);
                    }
                } catch (error) {
                    console.error('Avtomatik saqlangan kodni yuklashda xatolik:', error);
                }
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.getElementById('themeBtn');
            
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                themeBtn.textContent = 'â˜€ï¸ Light';
                localStorage.setItem('theme', 'dark');
            } else {
                themeBtn.textContent = 'ğŸŒ™ Dark';
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeBtn = document.getElementById('themeBtn');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeBtn.textContent = 'â˜€ï¸ Light';
            }
        }

        async function initPyodide() {
            const loading = document.getElementById('loading');
            loading.classList.add('active');
            
            try {
                pyodide = await loadPyodide();
                loading.textContent = 'âœ… Python tayyor!';
                setTimeout(() => {
                    loading.classList.remove('active');
                }, 2000);
            } catch (error) {
                loading.textContent = 'âŒ Xatolik: Python yuklanmadi!';
                loading.style.background = '#fee2e2';
                loading.style.color = '#991b1b';
            }
        }

        async function runCode() {
            if (!pyodide) {
                showOutput('âŒ Python hali yuklanmagan. Iltimos, kuting...', 'error');
                return;
            }

            const code = editor.getValue();
            
            if (!code.trim()) {
                showOutput('âš ï¸ Kod kiritilmagan!', 'error');
                return;
            }

            showOutput('â³ Bajarilmoqda...', '');

            try {
                pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
                `);

                const startTime = performance.now();
                await pyodide.runPythonAsync(code);
                const endTime = performance.now();
                const executionTime = ((endTime - startTime) / 1000).toFixed(3);

                const result = pyodide.runPython('sys.stdout.getvalue()');
                
                if (result) {
                    showOutput(`${result}\n\nâ± Bajarilish vaqti: ${executionTime} soniya`, 'success');
                } else {
                    showOutput(`âœ… Kod muvaffaqiyatli bajarildi\n\nâ± Bajarilish vaqti: ${executionTime} soniya`, 'success');
                }
            } catch (error) {
                showOutput(`âŒ Xatolik:\n\n${error.message}`, 'error');
            }
        }

        function clearOutput() {
            showOutput('Natija tozalandi. Kodni yozing va "Run" tugmasini bosing.', '');
        }

        function showOutput(text, type) {
            const output = document.getElementById('output');
            output.textContent = text;
            output.className = 'output-content ' + type;
        }

        function saveCode() {
            const code = editor.getValue();
            const savedCodes = JSON.parse(localStorage.getItem('pythonCodes') || '[]');
            const timestamp = new Date().toLocaleString('uz-UZ');
            
            savedCodes.unshift({
                code: code,
                timestamp: timestamp
            });

            if (savedCodes.length > 10) {
                savedCodes.pop();
            }

            localStorage.setItem('pythonCodes', JSON.stringify(savedCodes));
            showOutput(`âœ… Kod saqlandi (${timestamp})`, 'success');
            
            setTimeout(() => {
                clearOutput();
            }, 2000);
        }

        function loadCode() {
            const savedCodes = JSON.parse(localStorage.getItem('pythonCodes') || '[]');
            
            if (savedCodes.length === 0) {
                showOutput('âŒ Saqlangan kodlar topilmadi!', 'error');
                return;
            }

            editor.setValue(savedCodes[0].code);
            showOutput(`âœ… Oxirgi kod yuklandi (${savedCodes[0].timestamp})`, 'success');
            
            setTimeout(() => {
                clearOutput();
            }, 2000);
        }

        function downloadCode() {
            const code = editor.getValue();
            const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const filename = `python_code_${new Date().getTime()}.py`;
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showOutput(`âœ… Kod yuklab olindi: ${filename}`, 'success');
            
            setTimeout(() => {
                clearOutput();
            }, 2000);
        }

        function uploadFile(event) {
            const file = event.target.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                editor.setValue(content);
                showOutput(`âœ… Fayl yuklandi: ${file.name}`, 'success');
                
                setTimeout(() => {
                    clearOutput();
                }, 2000);
            };
            
            reader.onerror = function() {
                showOutput('âŒ Faylni o\'qishda xatolik yuz berdi!', 'error');
            };
            
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // Klaviatura qisqartmalari
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveCode();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                downloadCode();
            }
        });
    </script>
</body>
</html>